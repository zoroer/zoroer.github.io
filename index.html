<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>test</title>
</head>
<body>
  <div id=app>
    <input type="text" v-model="val1" />
    <p>{{val2}}</p>
    <div>{{val2}} test <span>{{val1}}</span></div>
    <button v-on:click="clickTest">点击更改val1的值</button></button>
  </div>

  <script>
    // 实际vue解析
    var vueData = {};

    // api定义
    var data  = {
      val1: 1,
      val2: 2,
    }

    var onUpdate = new CustomEvent("update");

    window.onload = function() {
      Object.keys(data).forEach(key => {
        reactData(vueData, key)
      })
      var rootEle = document.querySelector("#app");
      listDom(rootEle);
    }

    // 拦截数据
    function reactData(obj, key) {
      Object.defineProperty(obj, key, {
        get () {
          return data[key];
        },
        set (value) {
          data[key] = value;
          window.dispatchEvent(onUpdate);
        }
      })
    }

    /*
     * 渲染dom上应用的vue数据 
     * rootEle 扫描dom内所有子节点，处理包含特殊语法的元素
     */
    function listDom (rootEle) {  
      Array.from(rootEle.children).forEach(ele => {
        const tagName = ele.tagName.toLowerCase();
        if (tagName === 'input') {
          var bindAttr = ele.getAttribute('v-model');
          ele.value = vueData[bindAttr];
          ele.addEventListener('input', (e) => {
            const nowVal = e.target.value;
            vueData[bindAttr] = nowVal;
          });
          window.addEventListener('update', (e) => {
            ele.value = e.target.data[bindAttr];
          })
        } else {
          const innerDom = ele.innerHTML;
          ele.innerHTML = compileDom(innerDom);
          window.addEventListener('update', (e) => {
            ele.innerHTML = compileDom(innerDom);
          })
        }

        // 处理自定义事件
        Array.from(ele.attributes).forEach(attr => {
          const attrName = attr.localName;
          if (attrName.includes('v-on:')) {
            var eventName = attrName.split(':')[1];
            var eventHandler = ele.getAttribute(attrName);
            ele.addEventListener(eventName, window[eventHandler])
          }
        })
      });
    }
    function compileDom(innerDom) {
      var reg = /{{(.*?)}}/g;
      return innerDom.replace(reg, (match, $1, $2, $3) => {
        return vueData[$1];
      });
    }

    function clickTest() {
      vueData.val2 = 11111;
    }
  </script>
</body>
</html>