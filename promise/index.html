<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>promise view</title>
</head>
<body>
  <div id="app">
    <p>{{changeAfterSeconds}}秒之后加载promise回调</p>
  </div>

<script src="./event.js"></script>
<script src="../static/simple_vue.js"></script>
<script type="text/javascript">
  // api定义
  let data  = {
    changeAfterSeconds: 3,
  }

  /**
   * 优势：解耦函数跟相互关联逻辑的嵌套
   * Promise 功能点
   * promise对象参数 函数 函数的参数是2个函数resolve，reject
   */
  class SelfPromise {
    constructor(mainFunc) {
      this.status = 'pending';
      this.initCb(mainFunc);
    }
    initCb (mainFunc) {
      if (typeof mainFunc !== 'function') {
        throw new Error('Promise参数必须为函数');
      }
      mainFunc(this.resolveFunction.bind(this), this.rejectFunction.bind(this));
    }
    resolveFunction (val) {
      if (this.status === 'pending') {
        this.changeResolveStatus();
        Event.publish('resolve', val);
      }
    }
    rejectFunction (val) {
      if (this.status === 'pending') {
        this.changeRejectStatus();
        Event.publish('reject', val);
      }
    }
    changeResolveStatus () {
      this.status = 'fulfilled';
    }
    changeRejectStatus () {
      this.status = 'rejected';
    }
    then(resolvedCb, rejectedCb) {
      Event.subscribe('resolve', val => resolvedCb(val));
      Event.subscribe('reject', val => rejectedCb(val));
      return this;
    }
    catch(rejectedCb) {
      Event.subscribe('rejected', val => rejectedCb(val));
      return this;
    }
  }

  function timeout(ms) {
    return new SelfPromise((resolve, reject) => {
      setTimeout(resolve, ms, 'done');
    });
  }

  timeout(data.changeAfterSeconds * 1000).then((value) => {
    console.log(value);
    ProxyIns.changeAfterSeconds = 0;
  });
</script>
</body>
</html>
